# Jan 28 - assignment 3 

——————— module 6 —————— 
# Taxonomic analysis 
# access the silva file -> /mnt/datasets/classifiers# ls
gg-13-8-99-515-806-nb-classifier.qza  rep-tax.qza
gg-13-8-99-nb-classifier.qza	      silva-138-99-515-806-nb-classifier.qza
rep-seqs.qza			      silva-138-99-nb-classifier.qza

# the range 515-806 means the sequences are trimmed to those bp specifically
# open mouse_tutorial_1 in /data
# create a taxonomy.qza using this chunk of code 
# i-classifer indicates where the reference sequences are, and combine them with rep-seas
# silva-138-99-515-806 is a ref-sees file that has sequences for variable regions 3 and 4
# this code takes around 20 mins to run

(qiime2-2023.7) root@e28033ce5358:/data/mouse_tutorial_1# 
qiime feature-classifier classify-sklearn \
  --i-classifier /mnt/datasets/classifiers/silva-138-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza
Saved FeatureData[Taxonomy] to: taxonomy.qza

—————— for project 2, may need to re-train the classifier depending on the variable region —————— 

# Extract your amplicon of interest from the reference database
#replace the ref-otus.qza with the representative sequence file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza)
#replace primer sequences with your correct sequences
#replace trunc-len with the one you defined in your denoising step
qiime feature-classifier extract-reads \   --i-sequences ref-otus.qza \   --p-f-primer GTGCCAGCMGCCGCGGTAA \   --p-r-primer GGACTACHVGGGTWTCTAAT \   --p-trunc-len 150 \   --o-reads ref-seqs-trimmed.qza
 
# Train classifier with your new ref-seq file
# Replace ref-taxonomy.qza with the representative taxonomy file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-tax.qza)
qiime feature-classifier fit-classifier-naive-bayes \--i-reference-reads ref-seqs-trimmed.qza \--i-reference-taxonomy ref-taxonomy.qza \--o-classifier classifier.qza
 
# Use the trained classifier to assign taxonomy to your reads (rep-seqs.qza)
qiime feature-classifier classify-sklearn \--i-classifier classifier.qza \--i-reads rep-seqs.qza \--o-classification taxonomy.qza
———————————————————————————— 

# convert the taxonomy.qza file into qzv. to tabulate 
qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv
Saved Visualization to: taxonomy.qzv

# create a bar plot with the table and taxonomy file 
qiime taxa barplot \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --o-visualization taxa-bar-plots.qzv
Saved Visualization to: taxa-bar-plots.qzv

# at local computer, move the two qzv files into Mouse_Tutorial_ folder
scp root@10.19.139.126:/data/mouse_tutoria_1/taxonomy.qzv .
scp root@10.19.139.126:/data/mouse_tutorial_1/taxa-bar-plots.qzv

——————— MPT alpha rarefaction —————— 

# creating a table.qza without any mitochondria or chloroplast sequences
qiime taxa filter-table \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table table-no-mitochondria-no-chloroplast.qza
   qiime feature-table summarize \
  --i-table table-no-mitochondria-no-chloroplast.qza \
  --o-visualization table-no-mitochondria-no-chloroplast.qzv \
  --m-sample-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv 


# transfer the table-no-mitochondria-no-chloroplast.qza to your local computer
scp root@10.19.139.126:/data/mouse_tutorial_1/table-no-mitochondria-no-chloroplast.qzv .

# generate rooted and unrooted tree
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences rep-seqs.qza \
  --o-alignment aligned-rep-seqs.qza \
  --o-masked-alignment masked-aligned-rep-seqs.qza \
  --o-tree unrooted-tree.qza \
  --o-rooted-tree rooted-tree.qza 

# Alpha-rarefaction
# we chose 8000 as max-depth for moving_tutorial because in table.qzv, the maximum 9700 depth
# will chose max-depth as 4700 since max frequency is 4996
qiime diversity alpha-rarefaction \
  --i-table table.qza \
  --i-phylogeny rooted-tree.qza \
  --p-max-depth 4700 \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --o-visualization alpha-rarefaction.qzv

# transfer the rarefaction into local computer
scp root@10.19.139.126:/data/mouse_tutorial_1/alpha-rarefaction.qzv .


# Calculate alpha- and beta-diversity metrics
# XXXX is 4082 for the moving pictures tutorial because sampling depth needs to be over the plateau 
# For mouse tutorial, based on alpha rarefaction curve, anything above 500 is a good sampling depth because most of samples have saturated representation of ASVs 
# When looking at the table qzv, there are two 12 categories under the mouse_id metadata category, all with sampling size of 4 for all mouse_id’s. I decided to keep at least a sample size of 3 (arbitrary) for each category so my rarefaction parameter was 3288. At this sequencing depth, every category had at least 3 samples. If I go up to 3289, mouse_id 469 goes down to a sample size of 2.

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table table-no-mitochondria-no-chloroplast.qza \
  --p-sampling-depth 3288 \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --output-dir core-metrics-results
Saved FeatureTable[Frequency] to: core-metrics-results/rarefied_table.qza
Saved SampleData[AlphaDiversity] to: core-metrics-results/faith_pd_vector.qza
Saved SampleData[AlphaDiversity] to: core-metrics-results/observed_features_vector.qza
Saved SampleData[AlphaDiversity] to: core-metrics-results/shannon_vector.qza
Saved SampleData[AlphaDiversity] to: core-metrics-results/evenness_vector.qza
Saved DistanceMatrix to: core-metrics-results/unweighted_unifrac_distance_matrix.qza
Saved DistanceMatrix to: core-metrics-results/weighted_unifrac_distance_matrix.qza
Saved DistanceMatrix to: core-metrics-results/jaccard_distance_matrix.qza
Saved DistanceMatrix to: core-metrics-results/bray_curtis_distance_matrix.qza
Saved PCoAResults to: core-metrics-results/unweighted_unifrac_pcoa_results.qza
Saved PCoAResults to: core-metrics-results/weighted_unifrac_pcoa_results.qza
Saved PCoAResults to: core-metrics-results/jaccard_pcoa_results.qza
Saved PCoAResults to: core-metrics-results/bray_curtis_pcoa_results.qza
Saved Visualization to: core-metrics-results/unweighted_unifrac_emperor.qzv
Saved Visualization to: core-metrics-results/weighted_unifrac_emperor.qzv
Saved Visualization to: core-metrics-results/jaccard_emperor.qzv
Saved Visualization to: core-metrics-results/bray_curtis_emperor.qzv


# at moving_tutorial_1 folder, run these commands to turn qza files into qzv files 
# Calculate alpha groups significance
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --o-visualization core-metrics-results/faith-pd-group-significance.qzv

qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/evenness_vector.qza \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --o-visualization core-metrics-results/evenness-group-significance.qzv


——————————— Not sure how to do beta diversity significance analysis ———————————— 
# Calculate beta-group significance
qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --m-metadata-column donor_status \
  --o-visualization core-metrics-results/unweighted-unifrac-donor_status-significance.qzv \
  --p-pairwise

qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file /mnt/datasets/project_1/mouse_tutorial/metadata.tsv \
  --m-metadata-column subject \
  --o-visualization core-metrics-results/unweighted-unifrac-subject-group-significance.qzv \
  --p-pairwise

# transfer the qzv files to local computer Moving_Pictures_ folder 
# there are 8 qzv files in the core-metrics-results file 
# I transferred faith-pd-group-significance.qzv and evenness-group-significance.qzv
scp root@10.19.139.126:/data/mouse_tutorial_1/core-metrics-results/faith-pd-group-significance.qzv .

scp root@10.19.139.126:/data/mouse_tutorial_1/core-metrics-results/evenness-group-significance.qzv .

# visualize the blot plots with Qiime2 View online

# choose which alpha diversity metric to use 
# I chose Pielou’s Evenness because has a more significant value (q-value = 0.00167)


