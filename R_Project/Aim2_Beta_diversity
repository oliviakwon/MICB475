#------- load lib -------
library(phyloseq)
library(ggplot2)
library(dplyr)
library(reshape2)
library(tibble)
library(vegan)

#------- load data and subset -------
load("FD_rare_only_separate.Rdata")

#duplicate phylosesq object
phyloseq_FD<- FD_rare_only_separate 

#extract the sample data
sample_phyloseq_FD <- sample_data(phyloseq_FD)

# Retain specific column
phyloseq_FD_subset <- sample_phyloseq_FD [, c("Sample.Name", "Age.New.Bin", "Cage.ID", "Experiment.Group", 
                                              "Genotype", "Mouse.ID", "Phenotype.score", 
                                              "FD.severity", "Sex", "Weight.grams")]

# Replace the sample data in your phyloseq object with the updated one
sample_data(FD_rare_only_separate) <- phyloseq_FD_subset

FD_phyloseq_subset <- FD_rare_only_separate


#-------- Bray curtis distance --------
#plot the order in young, middle, then old
sample_data(FD_phyloseq_subset)$Age.New.Bin <- factor((sample_data(FD_phyloseq_subset)$Age.New.Bin),
                                         levels = c("young", "middle", "old"))

#create ordination for bray curtis
age.bray.ord = ordinate(FD_phyloseq_subset, "PCoA", "bray", na.rm = TRUE) 

#plot ordination
age.bray.ord.p = plot_ordination(FD_phyloseq_subset, #change this
                               age.bray.ord, #change this
                           color = "Age.New.Bin", #change this to the age category
                            title = "Bray-Curtis dissimilarity across mouse age") #change this

#format your plot
age.bray.ord.pp= age.bray.ord.p + #change this
  geom_point(size = 5)+ 
  scale_color_discrete(name = "Mouse age")+
  theme_bw()
  theme_update(strip.text.x = element_text(size = 28),
               strip.text.y = element_text(size = 28),
               axis.text.x = element_text(size = 24), # change to 18 for smaller x axis label
               axis.text.y = element_text(size = 24),
               axis.title.x = element_text(size = 28),
               axis.title.y = element_text(size = 28),
               legend.title = element_text(size = 28),
               legend.text = element_text(size = 28),
               plot.title = element_text(size = 28))
age.bray.ord.pp

png(("Bray-Curtis dissimilarity across mouse age.png"), width = 1920, height = 1080)
age.bray.ord.pp
dev.off()

#perform PERMANOVA
dist.bray <- vegdist(t(otu_table(FD_phyloseq_subset)), method="bray") # Bray-curtis

FD_phyloseq_sam = sample_data(FD_phyloseq_subset)
FD_phyloseq_sam_df <- data.frame(FD_phyloseq_sam)

adonis2(dist.bray ~ Age.New.Bin,data=FD_phyloseq_sam_df)


#-------- Jaccard distance  --------
#plot the order in young, middle, then old
sample_data(FD_phyloseq_subset)$Age.New.Bin <- factor((sample_data(FD_phyloseq_subset)$Age.New.Bin),
                                                      levels = c("young", "middle", "old"))
#create ordination for bray curtis
age.jaccard.ord = ordinate(FD_phyloseq_subset, "PCoA", 
                      "jaccard", na.rm = TRUE) 

#plot ordination
age.jaccard.ord.p = plot_ordination(FD_phyloseq_subset, #change this
                               age.jaccard.ord, #change this
                               color = "Age.New.Bin",
                               title = "Jaccard index across mouse age") #change this

#format your plot
age.jaccard.ord.pp= age.jaccard.ord.p + #change this
  geom_point(size = 3)+ 
  scale_color_discrete(name = "Mouse age")+
  theme_bw()
theme_update(strip.text.x = element_text(size = 28),
             strip.text.y = element_text(size = 28),
             axis.text.x = element_text(size = 24), # change to 18 for smaller x axis label
             axis.text.y = element_text(size = 24),
             axis.title.x = element_text(size = 28),
             axis.title.y = element_text(size = 28),
             legend.title = element_text(size = 28),
             legend.text = element_text(size = 28),
             plot.title = element_text(size = 28))

age.jaccard.ord.pp

png(("Jaccard index across mouse age.png"), width = 1080, height = 1080)
age.jaccard.ord.pp
dev.off()

#perform PERMANOVA
dist.jaccard <- vegdist(t(otu_table(FD_phyloseq_subset)), method="jaccard")

FD_phyloseq_sam = sample_data(FD_phyloseq_subset)
FD_phyloseq_sam_df <- data.frame(FD_phyloseq_sam)

adonis2(dist.jaccard ~ Age.New.Bin, data=FD_phyloseq_sam_df)

#-------- weighted unifrac distance (karen) --------
#use the same code as above
#name each of your dataset clearly
#use ?ordinate to identify how to input your distance method in ordinate() function
#for PERMANOVA test, 
#dm_unifrac <- UniFrac(phyloseq_object, weighted=TRUE) # Weighted UniFrac

#-------- unweighted unifrac distance (karen) --------
#use the same code as above
#name each of your dataset clearly
#use ?ordinate to identify how to input your distance method in ordinate() function
#for PERMANOVA test, 
#dm_unifrac <- UniFrac(phyloseq_object, weighted=TRUE) # Weighted UniFrac

