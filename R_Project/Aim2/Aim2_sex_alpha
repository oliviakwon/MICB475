# load libraries
library(tidyverse)
library(phyloseq)
library(ggsignif)
library(picante)


#load data and subset

load("FD_rare_only_separate.Rdata")

#duplicate phylosesq object
phyloseq_FD<- FD_rare_only_separate 

#extract the sample data
sample_phyloseq_FD <- sample_data(phyloseq_FD)

# Retain specific column
phyloseq_FD_subset <- sample_phyloseq_FD [, c("Sample.Name", "Age.New.Bin", "Cage.ID", "Experiment.Group", 
                                              "Genotype", "Mouse.ID", "Phenotype.score", 
                                              "FD.severity", "Sex", "Weight.grams")]

# Replace the sample data in your phyloseq object with the updated one
sample_data(FD_rare_only_separate) <- phyloseq_FD_subset

FD_phyloseq_subset <- FD_rare_only_separate

# extract alpha diversity information
alphadiv <- estimate_richness(FD_phyloseq_subset)
samp_dat <- sample_data(FD_phyloseq_subset)
samp_dat_wdiv <- data.frame(samp_dat, alphadiv)


#### RELATIVE ABUNDANCE ####
#only need otu table as dataframe
FD_phyloseq_otu<- otu_table(FD_phyloseq_subset)
FD_otu<-as.data.frame(FD_phyloseq_otu)

#convert abs read to relative abundance 
FD_otu_relative <- FD_otu %>%
  dplyr::mutate_at(c(1:ncol(FD_otu)), funs(./sum(.)*100))

#test whether each column (aka sample) is 100%
sum(FD_otu_relative$SRR17661697.fastq.gz)

#change the row to column
FD_otu_relative1<- rownames_to_column(FD_otu_relative, var ="ASV")

#melt the dataframe
FD_otu_relative_melt<- reshape2::melt(data = FD_otu_relative1, 
                                      measure.vars = 2:34, # melt using all sample columns
                                      variable.name = "Sample", # this will be the default x axis name
                                      value.name = "Relative_Abundance", # this will be the default y axis name
                                      as.is = TRUE # prevents type conversion of strings to factors
) #16929     2

#combine taxa info to the FD_otu_relative_melt
FD_phyloseq_tax<- tax_table(FD_phyloseq_subset)
FD_tax<-as.data.frame(FD_phyloseq_tax)
FD_tax1<- rownames_to_column(FD_tax, var ="ASV")

test<- dplyr::left_join(FD_otu_relative_melt,FD_tax1, by = "ASV")

#subset sample data with sample name and age
FD_phyloseq_sam = sample_data(FD_phyloseq_subset)
FD_phyloseq_sam_df <- data.frame(FD_phyloseq_sam)

FD_phyloseq_sam_sub<- subset(FD_phyloseq_sam_df, select = c("Sample.Name", "Sex"))

FD_phyloseq_sam_sub1 <- rownames_to_column(FD_phyloseq_sam_sub, var = "Sample")

#combine test and FD_phyloseq_sam_sub1
taxa_ra<- dplyr::left_join(test,FD_phyloseq_sam_sub1, by = "Sample")

#clean up the phylum name
taxa_ra$Phylum<- gsub("^[a-z]__", "",taxa_ra$Phylum )

ra.p<- ggplot(data =taxa_ra, aes(x= Sample.Name, y = Relative_Abundance))+
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")+
  ylab('Relative abundance (%)')+
  xlab("Sample name")+
  facet_grid(~factor(Sex, , levels=c("Male", "Female")), scales = "free_x")+
  ggtitle("Relative abundance of phylum across mouse sexes")+
  theme_classic(base_size = 18)+
  theme(axis.text.x=element_text(angle=+90, vjust=0.5, hjust=0))
  
ra.p



#### SHANNON ####

# run Wilxocon test on shannon indexes
wilcox_sh <- wilcox.test(Shannon ~ Sex, data=samp_dat_wdiv, exact = FALSE)
wilcox_sh

# graph shannon indexes to sex levels and annotate significance
shannon_sex <- ggplot(samp_dat_wdiv, aes(x=`Sex`, y=Shannon)) +
  scale_x_discrete(limits =c("Male", "Female")) +
  geom_boxplot() +
  geom_point(size = 2) +
  ggtitle("Shannon and Sex") +
  ylab('Shannon index') +
  xlab('Mouse sex') +
  theme(axis.text.x=element_text(angle=, vjust=0.5, hjust=0)) +
  geom_signif(comparisons = list(c("Male","Female")),
              y_position = c(4.4),
              annotations = c("0.5231"), textsize = 6) +
  theme_classic(base_size = 18)
shannon_sex

#### CHAO1 ####

# run Wilxocon test on Chao1 indexes
wilcox_ch <- wilcox.test(Chao1 ~ Sex, data=samp_dat_wdiv, exact = FALSE)
wilcox_ch

# graph Chao1 indexes to sex levels and annotate significance
chao1_sex <- ggplot(samp_dat_wdiv, aes(x=`Sex`, y=Chao1)) +
  scale_x_discrete(limits =c("Male", "Female")) +
  geom_boxplot() +
  geom_point(size = 2) +
  ggtitle("Chao1 and Sex") +
  ylab('Chao1 index') +
  xlab('Mouse sex') +
  theme(axis.text.x=element_text(angle=, vjust=0.5, hjust=0)) +
  geom_signif(comparisons = list(c("Male","Female")),
              y_position = c(180),
              annotations = c("0.5375"), textsize = 6) +
  theme_classic(base_size = 18)
chao1_sex
  

#### FAITH PHYLOGENETIC DIVERSITY ####
# import tree
tree <- read_tree("FD_tree.nwk")

# calculate Faith's phylogenetic diversity as PD
phylo_dist <- pd(t(otu_table(FD_rare_only_separate)), phy_tree(tree), include.root=T) 

# add the PD column to subseted phyloseq object
sample_data(FD_rare_only_separate)$PD <- phylo_dist$PD

# extract the PD column from the sample data
PD_column <- sample_data(FD_rare_only_separate)$PD

# Add the PD column to the working data frame
samp_dat_wdiv$PD <- PD_column

# run Wilxocon test on pd indexes
wilcox_pd <- wilcox.test(PD ~ Sex, data=samp_dat_wdiv, exact = FALSE)
wilcox_pd

# graph pd indexes to sex levels and annotate significance
pd_sex <- ggplot(samp_dat_wdiv, aes(x=`Sex`, y=PD)) +
  scale_x_discrete(limits =c("Male", "Female")) +
  geom_boxplot() +
  geom_point(size = 2) +
  ggtitle("Faith's Phylogenetic Diversity and Sex") +
  ylab("Faith's Phylogenetic Diversity index") +
  xlab('Mouse sex') +
  theme(axis.text.x=element_text(angle=, vjust=0.5, hjust=0)) +
  geom_signif(comparisons = list(c("Male","Female")),
              y_position = c(15.3),
              annotations = c("0.3007"), textsize = 6) +
  theme_classic(base_size = 18)
pd_sex


#### PIELOU'S EVENNESS ####

# look for the total number of species in the subsetted data
total_species <- as.numeric(ntaxa(FD_rare_only_separate))

# calculate pielou's evenness index
samp_dat_wdiv$pielou <- samp_dat_wdiv$Shannon/log(total_species)

# run Wilxocon test on pielou's evenness indexes
wilcox_pielou <- wilcox.test(pielou ~ Sex, data=samp_dat_wdiv, exact = FALSE)
wilcox_pielou

# graph pd indexes to sex levels and annotate significance
pielou_sex <- ggplot(samp_dat_wdiv, aes(x=`Sex`, y=pielou)) +
  scale_x_discrete(limits =c("Male", "Female")) +
  geom_boxplot() +
  geom_point(size = 2) +
  ggtitle("Pielou's Evenness Index and Sex") +
  ylab("Pielou's Evenness index") +
  xlab('Mouse sex') +
  theme(axis.text.x=element_text(angle=, vjust=0.5, hjust=0)) +
  geom_signif(comparisons = list(c("Male","Female")),
              y_position = c(0.71),
              annotations = c("0.5231"), textsize = 6) +
#             annotations = c("0.5231"), textsize = 18) +
  theme_classic(base_size = 18)
pielou_sex


#### EXPORT PLOTS AS PNGS ####

# Relative abundance one is at the end of part "RELATIVE ABUNDANCE"

png(("aim2_sex_relative_abundance.png"), width = 1000, height = 800)
ra.p
dev.off()

png(("aim2_sex_shannon.png"), width = 500, height = 500)
shannon_sex
dev.off()

png(("aim2_sex_chao1.png"), width = 500, height = 500)
chao1_sex
dev.off()

png(("aim2_sex_pd.png"), width = 500, height = 500)
pd_sex
dev.off()

png(("aim2_sex_pielou.png"), width = 500, height = 500)
pielou_sex
dev.off()



#### SUMMARY: Wilcoxon results ####
wilcox_sh

wilcox_ch

wilcox_pd

wilcox_pielou
